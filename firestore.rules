rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }
    
    function userRef() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }
    
    function userExists() {
      return exists(userRef());
    }
    
    function userDoc() {
      return get(userRef());
    }
    
    function isAdmin() {
      return signedIn() && userExists() && userDoc().data.role == "admin";
    }
    
    function isNavigator() {
      return signedIn() && userExists() && userDoc().data.role == "navigator";
    }
    
    function isActiveUser() {
      return signedIn() && userExists() && userDoc().data.status == "active";
    }
    
    // Users collection
    match /users/{uid} {
      allow read: if signedIn() && (request.auth.uid == uid || isAdmin());
      allow create: if signedIn() && request.auth.uid == uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Allowed users - for registration flow
    match /allowed_users/{id} {
      allow read: if signedIn(); // Allow any signed-in user to check if they're allowed
      allow create, update, delete: if isAdmin();
    }
    
    // Services master
    match /services_master/{serviceId} {
      allow read: if signedIn() && isActiveUser();
      allow create: if signedIn() && isActiveUser(); // Both can create
      allow update, delete: if isAdmin(); // Only admin can edit/delete
    }
    
    // Counters - needed for auto-increment SL No
    match /counters/{counterId} {
      allow read: if signedIn() && isActiveUser();
      allow write: if signedIn() && isActiveUser(); // Both admin and navigator need to increment
    }
    
    // Service entries
    match /service_entries/{entryId} {
      allow read: if isAdmin() || (isNavigator() && resource.data.navigatorId == request.auth.uid);
      allow create: if isAdmin() || (isNavigator() && request.resource.data.navigatorId == request.auth.uid);
      allow update: if isAdmin() || (isNavigator() && resource.data.navigatorId == request.auth.uid && request.resource.data.navigatorId == resource.data.navigatorId);
      allow delete: if isAdmin(); // Only admin can delete
    }
  }
}